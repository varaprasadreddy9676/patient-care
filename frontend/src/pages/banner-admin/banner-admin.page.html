<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button (click)="goBack()"></ion-back-button>
    </ion-buttons>
    <ion-title>Banner Management</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="goToAnalytics()">
        <ion-icon slot="start" name="analytics-outline"></ion-icon>
        Analytics
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <ion-toolbar>
    <ion-segment [(ngModel)]="selectedSegment" (ionChange)="segmentChanged($event)">
      <ion-segment-button value="list">
        <ion-label>Banners</ion-label>
      </ion-segment-button>
      <ion-segment-button value="create">
        <ion-label>{{ editingBannerId ? 'Edit' : 'Create' }}</ion-label>
      </ion-segment-button>
    </ion-segment>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Banner List -->
  <div *ngIf="selectedSegment === 'list'">
    <!-- Quick Stats Dashboard -->
    <div class="stats-dashboard">
      <ion-grid>
        <ion-row>
          <ion-col size="6" size-md="3">
            <ion-card class="stat-card">
              <ion-card-content>
                <div class="stat-icon">
                  <ion-icon name="megaphone-outline"></ion-icon>
                </div>
                <div class="stat-value">{{ getTotalBanners() }}</div>
                <div class="stat-label">Total Banners</div>
              </ion-card-content>
            </ion-card>
          </ion-col>
          <ion-col size="6" size-md="3">
            <ion-card class="stat-card">
              <ion-card-content>
                <div class="stat-icon success">
                  <ion-icon name="eye-outline"></ion-icon>
                </div>
                <div class="stat-value">{{ getActiveBanners() }}</div>
                <div class="stat-label">Active</div>
              </ion-card-content>
            </ion-card>
          </ion-col>
          <ion-col size="6" size-md="3">
            <ion-card class="stat-card">
              <ion-card-content>
                <div class="stat-icon primary">
                  <ion-icon name="eye-outline"></ion-icon>
                </div>
                <div class="stat-value">{{ getTotalImpressions() | number }}</div>
                <div class="stat-label">Total Views</div>
              </ion-card-content>
            </ion-card>
          </ion-col>
          <ion-col size="6" size-md="3">
            <ion-card class="stat-card">
              <ion-card-content>
                <div class="stat-icon tertiary">
                  <ion-icon name="hand-left-outline"></ion-icon>
                </div>
                <div class="stat-value">{{ getTotalClicks() | number }}</div>
                <div class="stat-label">Total Clicks</div>
              </ion-card-content>
            </ion-card>
          </ion-col>
        </ion-row>
      </ion-grid>
    </div>

    <!-- Search and Filter -->
    <div class="search-filter-container">
      <ion-searchbar
        [(ngModel)]="searchTerm"
        (ionInput)="applyFilters()"
        placeholder="Search banners..."
        debounce="300">
      </ion-searchbar>

      <div class="filter-row">
        <ion-select
          [(ngModel)]="filterStatus"
          (ionChange)="applyFilters()"
          placeholder="Status"
          interface="popover">
          <ion-select-option value="all">All Status</ion-select-option>
          <ion-select-option value="active">Active</ion-select-option>
          <ion-select-option value="inactive">Inactive</ion-select-option>
        </ion-select>

        <ion-select
          [(ngModel)]="filterLocation"
          (ionChange)="applyFilters()"
          placeholder="Location"
          interface="popover">
          <ion-select-option value="all">All Locations</ion-select-option>
          <ion-select-option value="home">Home</ion-select-option>
          <ion-select-option value="appointments">Appointments</ion-select-option>
          <ion-select-option value="emr">EMR</ion-select-option>
        </ion-select>

        <ion-select
          [(ngModel)]="sortBy"
          (ionChange)="applySorting()"
          placeholder="Sort By"
          interface="popover">
          <ion-select-option value="recent">Most Recent</ion-select-option>
          <ion-select-option value="oldest">Oldest</ion-select-option>
          <ion-select-option value="priority">Priority</ion-select-option>
          <ion-select-option value="impressions">Most Viewed</ion-select-option>
          <ion-select-option value="clicks">Most Clicked</ion-select-option>
        </ion-select>
      </div>

      <!-- Bulk Actions Toolbar -->
      <div class="bulk-actions-toolbar" *ngIf="selectedBanners.length > 0">
        <div class="selection-info">
          <ion-checkbox
            [(ngModel)]="selectAll"
            (ionChange)="toggleSelectAll()">
          </ion-checkbox>
          <span>{{ selectedBanners.length }} selected</span>
        </div>
        <div class="bulk-actions">
          <ion-button size="small" fill="outline" (click)="bulkActivate()">
            <ion-icon slot="start" name="eye-outline"></ion-icon>
            Activate
          </ion-button>
          <ion-button size="small" fill="outline" (click)="bulkDeactivate()">
            <ion-icon slot="start" name="eye-off-outline"></ion-icon>
            Deactivate
          </ion-button>
          <ion-button size="small" fill="outline" color="danger" (click)="bulkDelete()">
            <ion-icon slot="start" name="trash-outline"></ion-icon>
            Delete
          </ion-button>
        </div>
      </div>
    </div>

    <ion-list *ngIf="!loading && banners.length > 0">
      <ion-item *ngFor="let banner of banners" lines="full">
        <div class="banner-item">
          <div class="banner-checkbox">
            <ion-checkbox
              [checked]="isSelected(banner.id)"
              (ionChange)="toggleBannerSelection(banner.id)">
            </ion-checkbox>
          </div>
          <div class="banner-info">
            <h3>{{ banner.title }}</h3>
            <p class="description">{{ banner.description }}</p>
            <div class="meta">
              <ion-badge [color]="banner.isActive ? 'success' : 'medium'">
                {{ banner.isActive ? 'Active' : 'Inactive' }}
              </ion-badge>
              <ion-badge color="primary">{{ banner.contentType }}</ion-badge>
              <ion-badge color="tertiary">{{ banner.displayLocation }}</ion-badge>
            </div>
            <div class="stats">
              <span><strong>Impressions:</strong> {{ banner.totalImpressions }}</span>
              <span><strong>Clicks:</strong> {{ banner.totalClicks }}</span>
              <span><strong>CTR:</strong> {{ banner.clickThroughRate }}</span>
            </div>
          </div>
          <div class="banner-actions">
            <ion-button size="small" fill="clear" (click)="editBanner(banner)">
              <ion-icon name="create-outline"></ion-icon>
            </ion-button>
            <ion-button size="small" fill="clear" (click)="toggleBannerStatus(banner)">
              <ion-icon [name]="banner.isActive ? 'eye-off-outline' : 'eye-outline'"></ion-icon>
            </ion-button>
            <ion-button size="small" fill="clear" color="danger" (click)="deleteBanner(banner)">
              <ion-icon name="trash-outline"></ion-icon>
            </ion-button>
          </div>
        </div>
      </ion-item>
    </ion-list>

    <div *ngIf="loading" class="loading-container">
      <ion-spinner></ion-spinner>
      <p>Loading banners...</p>
    </div>

    <div *ngIf="!loading && banners.length === 0" class="empty-state">
      <ion-icon name="megaphone-outline" size="large"></ion-icon>
      <h2>No Banners Yet</h2>
      <p>Create your first banner to get started</p>
      <ion-button (click)="selectedSegment = 'create'">Create Banner</ion-button>
    </div>
  </div>

  <!-- Create/Edit Banner Form -->
  <div *ngIf="selectedSegment === 'create'" class="form-container">
    <form (ngSubmit)="saveBanner()">
      <!-- Basic Information -->
      <ion-list>
        <ion-list-header>
          <ion-label>Basic Information</ion-label>
        </ion-list-header>

        <ion-item>
          <ion-label position="floating">Title *</ion-label>
          <ion-input [(ngModel)]="form.title" name="title" required></ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="floating">Description</ion-label>
          <ion-textarea [(ngModel)]="form.description" name="description" rows="2"></ion-textarea>
        </ion-item>

        <!-- Content Type -->
        <ion-item>
          <ion-label>Content Type</ion-label>
          <ion-select [(ngModel)]="form.contentType" name="contentType">
            <ion-select-option value="text">Text Only</ion-select-option>
            <ion-select-option value="image">Image Only</ion-select-option>
            <ion-select-option value="video">Video Only</ion-select-option>
            <ion-select-option value="gif">GIF Only</ion-select-option>
            <ion-select-option value="combo">Combo (Text + Media)</ion-select-option>
          </ion-select>
        </ion-item>

        <!-- Rich Text Content -->
        <ion-item *ngIf="form.contentType === 'text' || form.contentType === 'combo'">
          <ion-label position="floating">Text Content (HTML)</ion-label>
          <ion-textarea [(ngModel)]="form.richTextContent" name="richTextContent" rows="4"></ion-textarea>
        </ion-item>

        <!-- Image Upload -->
        <ion-item *ngIf="form.contentType === 'image' || form.contentType === 'combo'">
          <ion-label position="stacked">Image</ion-label>
          <input type="file" accept="image/*" (change)="onFileSelected($event)" />
        </ion-item>

        <ion-item *ngIf="form.contentType === 'image' || form.contentType === 'combo'">
          <ion-label position="floating">Or Image URL</ion-label>
          <ion-input [(ngModel)]="form.imageUrl" name="imageUrl" type="url"></ion-input>
        </ion-item>

        <!-- Video Fields -->
        <ion-item *ngIf="form.contentType === 'video' || form.contentType === 'combo'">
          <ion-label>Video Type</ion-label>
          <ion-select [(ngModel)]="form.videoType" name="videoType">
            <ion-select-option value="youtube">YouTube</ion-select-option>
            <ion-select-option value="vimeo">Vimeo</ion-select-option>
            <ion-select-option value="direct">Direct (MP4/WebM)</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item *ngIf="form.contentType === 'video' || form.contentType === 'combo'">
          <ion-label position="floating">Video URL *</ion-label>
          <ion-input [(ngModel)]="form.videoUrl" name="videoUrl" type="url" placeholder="https://youtube.com/watch?v=..."></ion-input>
        </ion-item>

        <ion-item *ngIf="form.contentType === 'video' || form.contentType === 'combo'">
          <ion-label position="floating">Video Thumbnail URL (optional)</ion-label>
          <ion-input [(ngModel)]="form.videoThumbnail" name="videoThumbnail" type="url" placeholder="https://example.com/thumbnail.jpg"></ion-input>
        </ion-item>

        <!-- GIF Fields -->
        <ion-item *ngIf="form.contentType === 'gif' || form.contentType === 'combo'">
          <ion-label position="floating">GIF URL</ion-label>
          <ion-input [(ngModel)]="form.gifUrl" name="gifUrl" type="url" placeholder="https://example.com/animation.gif"></ion-input>
        </ion-item>

        <ion-item *ngIf="form.contentType === 'gif' || form.contentType === 'combo'">
          <ion-label position="stacked">Or Upload GIF</ion-label>
          <input type="file" accept="image/gif" (change)="onGifFileSelected($event)" />
        </ion-item>

        <!-- Size -->
        <ion-item>
          <ion-label>Size</ion-label>
          <ion-select [(ngModel)]="form.size" name="size">
            <ion-select-option value="small">Small</ion-select-option>
            <ion-select-option value="medium">Medium</ion-select-option>
            <ion-select-option value="large">Large</ion-select-option>
            <ion-select-option value="custom">Custom</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item *ngIf="form.size === 'custom'">
          <ion-label position="floating">Width (px)</ion-label>
          <ion-input [(ngModel)]="form.customWidth" name="customWidth" type="number"></ion-input>
        </ion-item>

        <ion-item *ngIf="form.size === 'custom'">
          <ion-label position="floating">Height (px)</ion-label>
          <ion-input [(ngModel)]="form.customHeight" name="customHeight" type="number"></ion-input>
        </ion-item>

        <!-- Click Behavior -->
        <ion-list-header>
          <ion-label>Click Behavior</ion-label>
        </ion-list-header>

        <ion-item>
          <ion-label>Action</ion-label>
          <ion-select [(ngModel)]="form.clickBehavior" name="clickBehavior">
            <ion-select-option value="external">External URL</ion-select-option>
            <ion-select-option value="internal">Internal Page</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item *ngIf="form.clickBehavior === 'external'">
          <ion-label position="floating">External URL</ion-label>
          <ion-input [(ngModel)]="form.externalUrl" name="externalUrl" type="url"></ion-input>
        </ion-item>

        <ion-item *ngIf="form.clickBehavior === 'internal'">
          <ion-label position="floating">Internal Route (e.g., /appointments)</ion-label>
          <ion-input [(ngModel)]="form.internalRoute" name="internalRoute"></ion-input>
        </ion-item>

        <!-- Display Settings -->
        <ion-list-header>
          <ion-label>Display Settings</ion-label>
        </ion-list-header>

        <ion-item>
          <ion-label>Display Location</ion-label>
          <ion-select [(ngModel)]="form.displayLocation" name="displayLocation">
            <ion-select-option value="all">All Pages</ion-select-option>
            <ion-select-option value="home">Home Only</ion-select-option>
            <ion-select-option value="appointments">Appointments Only</ion-select-option>
            <ion-select-option value="emr">EMR Only</ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-label position="floating">Priority (higher = more priority)</ion-label>
          <ion-input [(ngModel)]="form.priority" name="priority" type="number"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label>Active</ion-label>
          <ion-toggle [(ngModel)]="form.isActive" name="isActive"></ion-toggle>
        </ion-item>

        <!-- Schedule -->
        <ion-list-header>
          <ion-label>Schedule</ion-label>
        </ion-list-header>

        <ion-item>
          <ion-label position="floating">Start Date</ion-label>
          <ion-input [(ngModel)]="form.schedule.startDate" name="startDate" type="date"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="floating">End Date</ion-label>
          <ion-input [(ngModel)]="form.schedule.endDate" name="endDate" type="date"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="floating">Start Time</ion-label>
          <ion-input [(ngModel)]="form.schedule.startTime" name="startTime" type="time"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="floating">End Time</ion-label>
          <ion-input [(ngModel)]="form.schedule.endTime" name="endTime" type="time"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label>Frequency</ion-label>
          <ion-select [(ngModel)]="form.schedule.frequency" name="frequency">
            <ion-select-option value="always">Always</ion-select-option>
            <ion-select-option value="daily">Daily</ion-select-option>
            <ion-select-option value="weekly">Weekly</ion-select-option>
            <ion-select-option value="specific_days">Specific Days</ion-select-option>
          </ion-select>
        </ion-item>

        <!-- Frequency Caps -->
        <ion-item>
          <ion-label position="floating">Max Impressions Per User (optional)</ion-label>
          <ion-input [(ngModel)]="form.schedule.maxImpressionsPerUser" name="maxImpressionsPerUser" type="number"></ion-input>
        </ion-item>

        <ion-item>
          <ion-label position="floating">Max Clicks Per User (optional)</ion-label>
          <ion-input [(ngModel)]="form.schedule.maxClicksPerUser" name="maxClicksPerUser" type="number"></ion-input>
        </ion-item>
      </ion-list>

      <!-- Preview Section -->
      <div class="preview-section">
        <ion-button
          expand="block"
          fill="outline"
          color="secondary"
          (click)="togglePreview()"
          [disabled]="!isPreviewAvailable()">
          <ion-icon slot="start" [name]="showPreview ? 'eye-off-outline' : 'eye-outline'"></ion-icon>
          {{ showPreview ? 'Hide Preview' : 'Show Preview' }}
        </ion-button>

        <div class="preview-container" *ngIf="showPreview && isPreviewAvailable()">
          <div class="preview-label">
            <h3>Preview</h3>
            <p>This is how your banner will look:</p>
          </div>

          <div
            [class]="getPreviewBannerClass()"
            [style]="getPreviewBannerStyle()">

            <!-- Text only preview -->
            <div *ngIf="form.contentType === 'text'" class="preview-text-content">
              <div class="preview-rich-text" [innerHTML]="getPreviewSafeHtml()"></div>
            </div>

            <!-- Image only preview -->
            <div *ngIf="form.contentType === 'image'" class="preview-image-content">
              <img [src]="getPreviewImageSrc()" [alt]="form.title" />
            </div>

            <!-- Combo preview -->
            <div *ngIf="form.contentType === 'combo'" class="preview-combo-content">
              <div class="preview-combo-image">
                <img [src]="getPreviewImageSrc()" [alt]="form.title" />
              </div>
              <div class="preview-combo-text">
                <div class="preview-rich-text" [innerHTML]="getPreviewSafeHtml()"></div>
              </div>
            </div>
          </div>

          <div class="preview-info">
            <ion-chip color="primary">
              <ion-label>Size: {{ form.size }}</ion-label>
            </ion-chip>
            <ion-chip color="secondary">
              <ion-label>Type: {{ form.contentType }}</ion-label>
            </ion-chip>
            <ion-chip color="tertiary">
              <ion-label>Location: {{ form.displayLocation }}</ion-label>
            </ion-chip>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <ion-button expand="block" type="submit" color="primary">
          {{ editingBannerId ? 'Update Banner' : 'Create Banner' }}
        </ion-button>
        <ion-button expand="block" fill="outline" (click)="resetForm(); selectedSegment = 'list'">
          Cancel
        </ion-button>
      </div>
    </form>
  </div>
</ion-content>

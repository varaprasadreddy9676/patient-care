"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[2743],{2743:(G,p,l)=>{l.r(p),l.d(p,{ChatPage:()=>w});var m=l(467),i=l(9893),u=l(177),_=l(9417),e=l(4438),h=l(9012),f=l(600),M=l(8831);function C(s,r){1&s&&(e.j41(0,"div",11),e.nrm(1,"ion-spinner",12),e.j41(2,"p"),e.EFF(3,"Loading chat..."),e.k0s()())}function v(s,r){1&s&&e.nrm(0,"ion-spinner",21)}function P(s,r){1&s&&(e.j41(0,"span"),e.EFF(1,"Load older messages"),e.k0s())}function O(s,r){if(1&s){const o=e.RV6();e.j41(0,"div",17)(1,"ion-button",18),e.bIt("click",function(){e.eBV(o);const t=e.XpG(2);return e.Njj(t.loadOlderMessages())}),e.DNE(2,v,1,0,"ion-spinner",19)(3,P,2,0,"span",20),e.k0s()()}if(2&s){const o=e.XpG(2);e.R7$(),e.Y8G("disabled",o.loadingOlder),e.R7$(),e.Y8G("ngIf",o.loadingOlder),e.R7$(),e.Y8G("ngIf",!o.loadingOlder)}}function x(s,r){1&s&&(e.j41(0,"div",25)(1,"ion-chip",26),e.nrm(2,"ion-icon",27),e.j41(3,"ion-label"),e.EFF(4,"System Context Loaded"),e.k0s()()())}function y(s,r){1&s&&e.nrm(0,"ion-icon",33)}function b(s,r){1&s&&e.nrm(0,"ion-icon",34)}function I(s,r){if(1&s&&(e.j41(0,"div",28)(1,"div",29),e.EFF(2),e.k0s(),e.j41(3,"div",30),e.EFF(4),e.DNE(5,y,1,0,"ion-icon",31)(6,b,1,0,"ion-icon",32),e.k0s()()),2&s){const o=e.XpG().$implicit,n=e.XpG(2);e.AVh("pending",o.isPending)("error",o.hasError),e.R7$(2),e.SpI(" ",o.content," "),e.R7$(2),e.SpI(" ",n.formatTime(o.createdAt)," "),e.R7$(),e.Y8G("ngIf",o.isPending),e.R7$(),e.Y8G("ngIf",o.hasError)}}function T(s,r){if(1&s&&(e.j41(0,"div",35)(1,"div",36),e.nrm(2,"ion-icon",37),e.k0s(),e.j41(3,"div",38)(4,"div",29),e.EFF(5),e.k0s(),e.j41(6,"div",30),e.EFF(7),e.k0s()()()),2&s){const o=e.XpG().$implicit,n=e.XpG(2);e.R7$(5),e.SpI(" ",o.content," "),e.R7$(2),e.SpI(" ",n.formatTime(o.createdAt)," ")}}function k(s,r){if(1&s&&(e.j41(0,"div",22),e.DNE(1,x,5,0,"div",23)(2,I,7,8,"div",24)(3,T,8,2,"div",16),e.k0s()),2&s){const o=r.$implicit,n=e.XpG(2);e.R7$(),e.Y8G("ngIf",n.isSystemMessage(o)),e.R7$(),e.Y8G("ngIf",n.isUserMessage(o)),e.R7$(),e.Y8G("ngIf",!n.isUserMessage(o)&&!n.isSystemMessage(o))}}function E(s,r){1&s&&(e.j41(0,"div",35)(1,"div",36),e.nrm(2,"ion-icon",37),e.k0s(),e.j41(3,"div",39)(4,"div",40),e.nrm(5,"span")(6,"span")(7,"span"),e.k0s()()())}function R(s,r){if(1&s&&(e.j41(0,"div",13),e.DNE(1,O,4,3,"div",14)(2,k,4,3,"div",15)(3,E,8,0,"div",16),e.k0s()),2&s){const o=e.XpG();e.R7$(),e.Y8G("ngIf",o.hasMore),e.R7$(),e.Y8G("ngForOf",o.messages),e.R7$(),e.Y8G("ngIf",o.sending)}}let w=(()=>{var s;class r{constructor(n,t,a,g){this.route=n,this.navCtrl=t,this.chatService=a,this.alertCtrl=g,this.messages=[],this.messageText="",this.loading=!0,this.sending=!1,this.loadingOlder=!1,this.nextCursor=null,this.hasMore=!1}ngOnInit(){const n=history.state;if(null!=n&&n.sessionData)this.loadFromNavigationState(n.sessionData);else{const t=this.route.snapshot.paramMap.get("sessionId");t?(this.sessionId=t,this.loadSession()):(this.showError("Invalid session"),this.navCtrl.back())}}loadFromNavigationState(n){this.session=n.session,this.sessionId=this.session._id,this.messages=n.messages.items,this.nextCursor=n.messages.pagination.nextCursor,this.hasMore=n.messages.pagination.hasMore,this.loading=!1,setTimeout(()=>this.scrollToBottom(),100)}loadSession(){var n=this;return(0,m.A)(function*(){try{n.loading=!0;const t=yield n.chatService.getMessages(n.sessionId,50);n.messages=t.items,n.nextCursor=t.pagination.nextCursor,n.hasMore=t.pagination.hasMore,setTimeout(()=>n.scrollToBottom(),100)}catch(t){n.showError("Failed to load chat: "+((null==t?void 0:t.message)||"Unknown error")),n.navCtrl.back()}finally{n.loading=!1}})()}loadOlderMessages(n){var t=this;return(0,m.A)(function*(){var a;if(t.hasMore&&!t.loadingOlder)try{var g;t.loadingOlder=!0;const d=yield t.chatService.getMessages(t.sessionId,20,null!==(g=t.nextCursor)&&void 0!==g?g:void 0);t.messages=[...d.items,...t.messages],t.nextCursor=d.pagination.nextCursor,t.hasMore=d.pagination.hasMore}catch{t.showError("Failed to load older messages")}finally{var c;t.loadingOlder=!1,null==n||null===(c=n.target)||void 0===c||c.complete()}else null==n||null===(a=n.target)||void 0===a||a.complete()})()}sendMessage(){var n=this;return(0,m.A)(function*(){var t;if(null===(t=n.messageText)||void 0===t||!t.trim()||n.sending)return;const a=n.messageText.trim();n.messageText="";const g={_id:"temp-"+Date.now(),sessionId:n.sessionId,role:"user",content:a,createdAt:(new Date).toISOString(),isPending:!0};n.messages.push(g),n.scrollToBottom();try{n.sending=!0;const c=yield n.chatService.sendMessage(n.sessionId,a);n.messages=n.messages.filter(d=>d._id!==g._id),n.messages.push(c.userMessage),n.messages.push(c.assistantMessage),n.scrollToBottom()}catch(c){g.isPending=!1,g.hasError=!0;const d=(null==c?void 0:c.message)||"";d.includes("503")||d.includes("unavailable")?n.showRetryOption():n.showError("Failed to send message: "+(d||"Unknown error"))}finally{n.sending=!1}})()}retryLastMessage(){var n=this;return(0,m.A)(function*(){try{n.sending=!0,n.messages=n.messages.filter(a=>!a.hasError);const t=yield n.chatService.retryMessage(n.sessionId);n.messages.push(t.userMessage),n.messages.push(t.assistantMessage),n.scrollToBottom()}catch(t){n.showError("Retry failed: "+((null==t?void 0:t.message)||"Unknown error"))}finally{n.sending=!1}})()}showRetryOption(){var n=this;return(0,m.A)(function*(){yield(yield n.alertCtrl.create({header:"AI Temporarily Unavailable",message:"The AI assistant is currently unavailable. Would you like to retry?",buttons:[{text:"Cancel",role:"cancel"},{text:"Retry",handler:()=>{n.retryLastMessage()}}]})).present()})()}showError(n){var t=this;return(0,m.A)(function*(){yield(yield t.alertCtrl.create({header:"Error",message:n,buttons:["OK"]})).present()})()}scrollToBottom(){setTimeout(()=>{var n;null===(n=this.content)||void 0===n||n.scrollToBottom(300)},100)}isUserMessage(n){return"user"===n.role}isSystemMessage(n){return"system"===n.role}formatTime(n){return new Date(n).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})}goBack(){this.navCtrl.back()}}return(s=r).\u0275fac=function(n){return new(n||s)(e.rXU(h.nX),e.rXU(f.q9),e.rXU(M.m),e.rXU(i.hG))},s.\u0275cmp=e.VBU({type:s,selectors:[["app-chat"]],viewQuery:function(n,t){if(1&n&&e.GBs(i.W9,5),2&n){let a;e.mGM(a=e.lsd())&&(t.content=a.first)}},standalone:!0,features:[e.aNF],decls:16,vars:7,consts:[["color","primary"],["slot","start"],[3,"click"],["name","arrow-back"],[3,"fullscreen"],["class","loading-container",4,"ngIf"],["class","messages-container",4,"ngIf"],["lines","none"],["placeholder","Type your message...","rows","1","autoGrow","true","maxlength","1000",3,"ngModelChange","keyup.enter","ngModel","disabled"],["slot","end","fill","clear",3,"click","disabled"],["slot","icon-only","name","send"],[1,"loading-container"],["name","crescent"],[1,"messages-container"],["class","load-more-container",4,"ngIf"],["class","message-wrapper",4,"ngFor","ngForOf"],["class","message ai-message",4,"ngIf"],[1,"load-more-container"],["fill","clear","size","small",3,"click","disabled"],["name","dots",4,"ngIf"],[4,"ngIf"],["name","dots"],[1,"message-wrapper"],["class","system-message",4,"ngIf"],["class","message user-message",3,"pending","error",4,"ngIf"],[1,"system-message"],["color","medium","outline","true"],["name","information-circle-outline"],[1,"message","user-message"],[1,"message-content"],[1,"message-time"],["name","time-outline",4,"ngIf"],["name","alert-circle","color","danger",4,"ngIf"],["name","time-outline"],["name","alert-circle","color","danger"],[1,"message","ai-message"],[1,"ai-avatar"],["name","medical-outline"],[1,"message-bubble"],[1,"message-bubble","typing"],[1,"typing-indicator"]],template:function(n,t){1&n&&(e.j41(0,"ion-header")(1,"ion-toolbar",0)(2,"ion-buttons",1)(3,"ion-button",2),e.bIt("click",function(){return t.goBack()}),e.nrm(4,"ion-icon",3),e.k0s()(),e.j41(5,"ion-title"),e.EFF(6),e.k0s()()(),e.j41(7,"ion-content",4),e.DNE(8,C,4,0,"div",5)(9,R,4,3,"div",6),e.k0s(),e.j41(10,"ion-footer")(11,"ion-toolbar")(12,"ion-item",7)(13,"ion-textarea",8),e.mxI("ngModelChange",function(g){return e.DH7(t.messageText,g)||(t.messageText=g),g}),e.bIt("keyup.enter",function(){return t.sendMessage()}),e.k0s(),e.j41(14,"ion-button",9),e.bIt("click",function(){return t.sendMessage()}),e.nrm(15,"ion-icon",10),e.k0s()()()()),2&n&&(e.R7$(6),e.JRh((null==t.session?null:t.session.title)||"AI Chat"),e.R7$(),e.Y8G("fullscreen",!0),e.R7$(),e.Y8G("ngIf",t.loading),e.R7$(),e.Y8G("ngIf",!t.loading),e.R7$(4),e.R50("ngModel",t.messageText),e.Y8G("disabled",t.sending),e.R7$(),e.Y8G("disabled",!t.messageText.trim()||t.sending))},dependencies:[i.bv,i.Jm,i.QW,i.ZB,i.W9,i.M0,i.eU,i.iq,i.uz,i.he,i.w2,i.nc,i.BC,i.ai,i.Gw,u.bT,u.pM,_.YN,_.BC,_.tU,_.vS],styles:[".loading-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:var(--ion-color-medium)}.loading-container[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin-top:16px}.messages-container[_ngcontent-%COMP%]{padding:16px 16px 80px}.load-more-container[_ngcontent-%COMP%]{text-align:center;margin-bottom:16px}.message-wrapper[_ngcontent-%COMP%]{margin-bottom:16px}.system-message[_ngcontent-%COMP%]{text-align:center;margin:8px 0}.system-message[_ngcontent-%COMP%]   ion-chip[_ngcontent-%COMP%]{font-size:12px}.message[_ngcontent-%COMP%]{display:flex;flex-direction:column;max-width:75%;margin-bottom:8px;animation:_ngcontent-%COMP%_fadeIn .3s ease-in}.user-message[_ngcontent-%COMP%]{align-self:flex-end;margin-left:auto}.user-message[_ngcontent-%COMP%]   .message-content[_ngcontent-%COMP%]{background-color:var(--ion-color-primary);color:#fff;padding:12px 16px;border-radius:18px 18px 4px;word-wrap:break-word;white-space:pre-wrap}.user-message[_ngcontent-%COMP%]   .message-time[_ngcontent-%COMP%]{font-size:11px;color:var(--ion-color-medium);text-align:right;margin-top:4px;padding-right:4px;display:flex;align-items:center;justify-content:flex-end;gap:4px}.user-message[_ngcontent-%COMP%]   .message-time[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:14px}.user-message.pending[_ngcontent-%COMP%]{opacity:.7}.user-message.error[_ngcontent-%COMP%]   .message-content[_ngcontent-%COMP%]{background-color:var(--ion-color-danger)}.ai-message[_ngcontent-%COMP%]{display:flex;flex-direction:row;align-items:flex-start;max-width:85%}.ai-message[_ngcontent-%COMP%]   .ai-avatar[_ngcontent-%COMP%]{width:32px;height:32px;border-radius:50%;background-color:var(--ion-color-light);display:flex;align-items:center;justify-content:center;margin-right:8px;flex-shrink:0}.ai-message[_ngcontent-%COMP%]   .ai-avatar[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:20px;color:var(--ion-color-primary)}.ai-message[_ngcontent-%COMP%]   .message-bubble[_ngcontent-%COMP%]{flex:1}.ai-message[_ngcontent-%COMP%]   .message-bubble[_ngcontent-%COMP%]   .message-content[_ngcontent-%COMP%]{background-color:var(--ion-color-light);color:var(--ion-text-color);padding:12px 16px;border-radius:18px 18px 18px 4px;word-wrap:break-word;white-space:pre-wrap;line-height:1.5}.ai-message[_ngcontent-%COMP%]   .message-bubble[_ngcontent-%COMP%]   .message-time[_ngcontent-%COMP%]{font-size:11px;color:var(--ion-color-medium);margin-top:4px;padding-left:4px}.ai-message[_ngcontent-%COMP%]   .message-bubble.typing[_ngcontent-%COMP%]   .message-content[_ngcontent-%COMP%]{padding:16px 20px}.typing-indicator[_ngcontent-%COMP%]{display:flex;align-items:center;gap:4px}.typing-indicator[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{width:8px;height:8px;border-radius:50%;background-color:var(--ion-color-medium);animation:_ngcontent-%COMP%_typing 1.4s infinite}.typing-indicator[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:nth-child(1){animation-delay:0s}.typing-indicator[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:nth-child(2){animation-delay:.2s}.typing-indicator[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:nth-child(3){animation-delay:.4s}@keyframes _ngcontent-%COMP%_typing{0%,60%,to{opacity:.3;transform:translateY(0)}30%{opacity:1;transform:translateY(-10px)}}@keyframes _ngcontent-%COMP%_fadeIn{0%{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}ion-footer[_ngcontent-%COMP%]   ion-toolbar[_ngcontent-%COMP%]{--background: var(--ion-background-color);--border-color: var(--ion-color-light)}ion-footer[_ngcontent-%COMP%]   ion-toolbar[_ngcontent-%COMP%]   ion-item[_ngcontent-%COMP%]{--background: transparent;--padding-start: 8px;--padding-end: 8px;--inner-padding-end: 0}ion-footer[_ngcontent-%COMP%]   ion-toolbar[_ngcontent-%COMP%]   ion-item[_ngcontent-%COMP%]   ion-textarea[_ngcontent-%COMP%]{--padding-start: 12px;--padding-end: 8px;--padding-top: 8px;--padding-bottom: 8px;font-size:15px}ion-footer[_ngcontent-%COMP%]   ion-toolbar[_ngcontent-%COMP%]   ion-item[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{--padding-start: 8px;--padding-end: 8px;margin:0}@media (prefers-color-scheme: dark){.ai-message[_ngcontent-%COMP%]   .message-bubble[_ngcontent-%COMP%]   .message-content[_ngcontent-%COMP%]{background-color:var(--ion-color-step-150)}}"]}),r})()}}]);